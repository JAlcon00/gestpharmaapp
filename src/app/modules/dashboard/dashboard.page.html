<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Dashboard</ion-title>
    <ion-buttons slot="end">
      <app-theme-toggle></app-theme-toggle>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="dashboard-container ion-padding">
    <!-- Loading Skeletons -->
    @if (loading) {
    <div class="dashboard-skeletons">
      <!-- KPI Cards Skeletons -->
      <div class="kpi-skeletons">
        <app-skeleton variant="card" *ngFor="let i of [1,2,3,4,5,6]"></app-skeleton>
      </div>

      <!-- Chart Skeletons -->
      <div class="charts-skeletons">
        <app-skeleton variant="chart" width="100%" height="300px"></app-skeleton>
        <app-skeleton variant="chart" width="100%" height="300px"></app-skeleton>
      </div>
    </div>
    }

    <!-- Error -->
    @if (error && !loading) {
    <app-card variant="outlined">
      <div slot="content">
        <p class="text-danger">{{ error }}</p>
        <app-button (clicked)="loadDashboard()" variant="secondary" iconStart="refresh-outline">
          Reintentar
        </app-button>
      </div>
    </app-card>
    }

    <!-- KPIs Grid Asimétrico -->
    @if (dashboardData && !loading) {
    <div class="kpi-grid">
       <!-- Hero Card - Ventas Hoy (Destacada) -->
        <app-kpi-card
          type="sales"
          label="Ventas Hoy"
          [value]="dashboardData.totalVentasHoy"
          [trend]="15.3"
          [isHero]="true"
          [sparklineData]="[45000, 52000, 48000, 61000, 55000, 52750]">
        </app-kpi-card>

        <!-- Secondary Cards -->
        <app-kpi-card
          type="products"
          label="Productos"
          [value]="dashboardData.totalProductos"
          subtitle="En inventario">
        </app-kpi-card>

        <app-kpi-card
          type="stock"
          label="Stock Bajo"
          [value]="dashboardData.productosStockBajo"
          [trend]="dashboardData.productosStockBajo > 5 ? -12.5 : 0"
          subtitle="Requieren atención">
        </app-kpi-card>

        <app-kpi-card
          type="clients"
          label="Clientes"
          [value]="dashboardData.totalClientes"
          [trend]="8.2"
          subtitle="Registrados">
        </app-kpi-card>

        <!-- Revenue Cards -->
        <app-kpi-card
          type="revenue"
          label="Ventas Semana"
          [value]="dashboardData.totalVentasSemana"
          [trend]="22.1">
        </app-kpi-card>

        <app-kpi-card
          type="revenue"
          label="Ventas Mes"
          [value]="dashboardData.totalVentasMes"
          [trend]="18.7">
        </app-kpi-card>
    </div>

      <!-- Gráficos Interactivos -->
      <div class="charts-grid">
        <!-- Gráfico de Ventas Principales -->
        <ion-card class="chart-card chart-card--primary">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="trending-up-outline"></ion-icon>
              Ventas de los Últimos 7 Días
            </ion-card-title>
            <ion-card-subtitle>Seguimiento diario de ingresos</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="chart-container">
              <canvas #salesChart></canvas>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Gráfico de Productos Más Vendidos -->
        <ion-card class="chart-card chart-card--secondary">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="stats-chart-outline"></ion-icon>
              Top Productos
            </ion-card-title>
            <ion-card-subtitle>Productos más vendidos esta semana</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <div class="top-products-chart">
              @for (product of topProducts.slice(0, 5); track product.productoId) {
              <div class="product-bar">
                <div class="product-info">
                  <span class="product-name">{{ product.nombreProducto }}</span>
                  <span class="product-sales">{{ product.cantidadVendida }} vendidos</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill"
                       [style.width.%]="(product.cantidadVendida / (topProducts[0]?.cantidadVendida || 1)) * 100">
                  </div>
                </div>
              </div>
              }
            </div>
          </ion-card-content>
        </ion-card>
      </div>

     <!-- Ventas Recientes y Productos Top -->
     <ion-grid>
       <ion-row>
         <ion-col size="6">
           <ion-card>
             <ion-card-header>
               <ion-card-title>
                 <ion-icon name="time-outline"></ion-icon>
                 Ventas Recientes
               </ion-card-title>
             </ion-card-header>
             <ion-card-content class="no-padding">
               <ion-list>
                 @for (sale of recentSales; track sale.id) {
                 <ion-item>
                   <ion-label>
                     <h3>{{ sale.total | currency:'MXN':'symbol':'1.2-2' }}</h3>
                     <p>{{ sale.fechaVenta | date:'short' }}</p>
                   </ion-label>
                   <ion-badge slot="end" color="success">{{ sale.estado }}</ion-badge>
                 </ion-item>
                 }
                 @if (recentSales.length === 0) {
                 <ion-item>
                   <ion-label>
                     <p>No hay ventas recientes</p>
                   </ion-label>
                 </ion-item>
                 }
               </ion-list>
             </ion-card-content>
           </ion-card>
         </ion-col>

         <ion-col size="6">
           <ion-card>
             <ion-card-header>
               <ion-card-title>
                 <ion-icon name="trending-up-outline"></ion-icon>
                 Productos Más Vendidos
               </ion-card-title>
             </ion-card-header>
             <ion-card-content class="no-padding">
               <ion-list>
                 @for (product of topProducts; track product.productoId) {
                 <ion-item>
                   <ion-label>
                     <h3>{{ product.nombreProducto }}</h3>
                     <p>{{ product.cantidadVendida }} vendidos</p>
                   </ion-label>
                   <ion-badge slot="end" color="primary">
                     {{ product.totalVentas | currency:'MXN':'symbol':'1.2-2' }}
                   </ion-badge>
                 </ion-item>
                 }
                 @if (topProducts.length === 0) {
                 <ion-item>
                   <ion-label>
                     <p>No hay datos disponibles</p>
                   </ion-label>
                 </ion-item>
                 }
               </ion-list>
             </ion-card-content>
           </ion-card>
         </ion-col>
       </ion-row>
     </ion-grid>
     }

    <!-- Quick Actions FAB -->
    <app-quick-actions></app-quick-actions>
  </div>
</ion-content>
